# shellcheck shell=bash

# upwind specific config

# shellcheck disable=SC1091
export UPWIND_DEV_ORG_ID="org_8xFvjw2CxGPfGjwr"
if [ -f "${HOME}/Documents/upwind_token.sh" ]; then
  . "${HOME}/Documents/upwind_token.sh"
fi

# aws 
export DEV_VM_ID="i-0f62707b5fb2a4baa"
export AWS_REGION="us-east-1"
export AWS_PROFILE=dev-power-user # default profile
alias awsp='export AWS_PROFILE=$(sed -n "s/\[profile \(.*\)\]/\1/gp" ~/.aws/config | fzf)'
alias login='aws sso login'
alias aws_creds='eval $(aws configure export-credentials --profile ${AWS_PROFILE} --format env)'
alias aws_creds_reset='unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN AWS_CREDENTIAL_EXPIRATION'
alias intellij='aws_creds && open -a "IntelliJ IDEA CE" ; sleep 1 ; aws_creds_reset'
alias compass='aws_creds && open -a "MongoDB Compass" ; sleep 1 ; aws_creds_reset'
# shellcheck disable=SC2154
alias git_maintenance='for repo in ~/upwind/* ~/src/* ; do [ -d "${repo:?}"/.git ] && (cd "${repo:?}" && git maintenance register) ; done'

# dev
export UPWIND_KEYS_DIR="${HOME}/upwind/keys"
alias grpc-tun='ssh -NR 8209:localhost:8209 -NR 8210:localhost:8210 ${DEV_VM_ID}'
alias glp="git log --pretty=format:'%C(yellow)%h|%Cred%ad|%C(cyan)%an|%Cgreen%d %Creset%s' --date=local"

### Dev VM
function dev-vm-up()
{
    INSTANCE_ID="${DEV_VM_ID}"
    REGION="us-east-1"

    aws ec2 start-instances --instance-ids "$INSTANCE_ID" --region $REGION

    echo "Waiting for the instance to be in 'running' state..."
    aws ec2 wait instance-running --instance-ids "$INSTANCE_ID" --region $REGION

    PUBLIC_IP=$(aws ec2 describe-instances --instance-ids "$INSTANCE_ID" --region $REGION --query "Reservations[*].Instances[*].PublicIpAddress" --output text)

    echo "The public IP address of instance $INSTANCE_ID is: $PUBLIC_IP"
}

function dev-vm-down()
{
    INSTANCE_ID="${DEV_VM_ID}"
    REGION="us-east-1"
    aws ec2 stop-instances --instance-ids "$INSTANCE_ID" --region "$REGION"
}

### DB Queries
function multiquery() 
{
  URL="http://monitoring-receiver.prod.internal:5000/query/"
  SQL_QUERY="$1"
  BODY='{"sql":"'"$SQL_QUERY"'","orgIds":[],"clusterNames":["orgs01","orgs02","orgs03","orgs04","orgsDemo","orgsPoc"],"format":"json"}'
  curl -X POST "$URL" \
    -H 'Content-Type: application/json' \
    -d "$BODY" \
    | jq
}

# curl --location 'http://monitoring-receiver.prod.internal:5000/query/' \
# --header 'Content-Type: application/json' \
# --data '{
#   "sql": "SELECT reason, COUNT(*) AS failure_count FROM cloudscanner_image_jobs WHERE state = '\''FAILED'\'' AND createdAt >= NOW() - INTERVAL 24 HOUR GROUP BY reason ORDER BY failure_count DESC;",
#   "orgIds": [
#   ],
#   "clusterNames": [
#     "orgs01",
#     "orgsDemo",
#     "orgsPoc",
#     "orgs02",
#     "orgs03"
#   ],
#   "format": "json"
# }

# ' | jq .

function org_search () {
    local search_string="$1" 
    if [[ -z "$search_string" ]]
    then
            echo "Usage: org_search <search_string>"
            return 1
    fi
    URL_US="http://monitoring-receiver.us-east-1.prod.internal:5000/query/" 
    URL_EU="http://monitoring-receiver.eu-central-1.prod.internal:5000/query/" 
    URL_ME="http://monitoring-receiver.me-central-1.prod.internal:5000/query/" 
    BODY='{"sql":"SELECT orgId, orgName, clusterName FROM org_db_mappings","orgIds":[],"clusterNames":["coreDb"],"format":"json"}' 
    curl -s -X POST $URL_US -H 'Content-Type: application/json' -d "$BODY" | jq --arg search "$search_string" '.result.coreDb[] | select(((.orgId // "") | test($search; "i")) or ((.orgName // "") |  test($search; "i"))) | . + {region: "US"}'
    curl -s -X POST $URL_EU -H 'Content-Type: application/json' -d "$BODY" | jq --arg search "$search_string" '.result.coreDb[] | select(((.orgId // "") | test($search; "i")) or ((.orgName // "") |  test($search; "i"))) | . + {region: "EU"}'
    curl -s -X POST $URL_ME -H 'Content-Type: application/json' -d "$BODY" | jq --arg search "$search_string" '.result.coreDb[] | select(((.orgId // "") | test($search; "i")) or ((.orgName // "") |  test($search; "i"))) | . + {region: "ME"}'
}

function org_search_dev () {
    local search_string="$1" 
    if [[ -z "$search_string" ]]
    then
            echo "Usage: org_search <search_string>"
            return 1
    fi
    URL_US="http://monitoring-receiver.us-east-1.dev.internal:5000/query/" 
    URL_EU="http://monitoring-receiver.eu-central-1.dev.internal:5000/query/" 
    BODY='{"sql":"SELECT orgId, orgName, clusterName FROM org_db_mappings","orgIds":[],"clusterNames":["coreDb"],"format":"json"}' 
    curl -s -X POST $URL_US -H 'Content-Type: application/json' -d "$BODY" | jq --arg search "$search_string" '.result.coreDb[] | select(((.orgId // "") | test($search; "i")) or ((.orgName // "") |  test($search; "i"))) | . + {region: "US"}'
    curl -s -X POST $URL_EU -H 'Content-Type: application/json' -d "$BODY" | jq --arg search "$search_string" '.result.coreDb[] | select(((.orgId // "") | test($search; "i")) or ((.orgName // "") |  test($search; "i"))) | . + {region: "EU"}'
}

### Working with docker images
# build dockerfile, create image and export file system
function docker-build-export()
{
    docker build -t tempimg .
    cid=$(docker create tempimg)
    mkdir -p output
    docker export "$cid" | tar -C output -xvf -
    docker rm "$cid"
    docker rmi tempimg
}

# Take existing image create filesystem and export it
# Arg1: name of image/sha
# Arg2: output folder
function docker-export()
{
    cid=$(docker create "$1")
    docker export "${cid}" | tar -xC "$2"
    docker rm "${cid}"
}

### Repo commands
## s3-auth-service - get a bearer token
function genlabstokendev() 
{
	UPWIND_AUTH_AUDIENCE="https://agent.upwind.dev"
	UPWIND_AUTH_ENDPOINT="https://oauth.upwind.dev/oauth/token"
	curl -fsSL -X POST --url $UPWIND_AUTH_ENDPOINT --data grant_type=client_credentials --data "audience=${UPWIND_AUTH_AUDIENCE}" --data "client_id=${UPWIND_CLIENT_ID}" --data "client_secret=${UPWIND_CLIENT_SECRET}" | jq -r '.access_token' > "${UPWIND_KEYS_DIR}/labstokendev"
}

export NVM_DIR="$HOME/.nvm"
# shellcheck disable=SC1091
[ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && \. "/opt/homebrew/opt/nvm/nvm.sh"  # This loads nvm
# shellcheck disable=SC1091
[ -s "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm" ] && \. "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm"  # This loads nvm bash_completion

### Azure VM 
# Check ip address in /etc/hosts, there is a command in devtools azure/terraform/cloudscanner-dev-vmss/get-publicip.sh to retrieve it
# ./get-publicip.sh cloudscanner-sandbox rkirk-vmss-ucsc-8f8445ef3b35de2d

alias azure_dev_vm_up='az vmss start --resource-group cloudscanner-sandbox --name rkirk-vmss-ucsc-8f8445ef3b35de2d'
alias azure_dev_vm_down='az vmss stop --resource-group cloudscanner-sandbox --name rkirk-vmss-ucsc-8f8445ef3b35de2d'
alias azure_dev_vm_list_ip="az vmss list-instance-public-ips --resource-group cloudscanner-sandbox --name rkirk-vmss-ucsc-8f8445ef3b35de2d | jq -r '.[].ipAddress'"
function azure_dev_vm_fix_ip()
{
    local ip
    ip=$(az vmss list-instance-public-ips --resource-group cloudscanner-sandbox --name rkirk-vmss-ucsc-8f8445ef3b35de2d | jq -r '.[].ipAddress')
    if grep -q 'az-rkirk-scaleset' /etc/hosts; then
        sudo sed -i.bak "s/.*az-rkirk-scaleset.*/$ip az-rkirk-scaleset/" /etc/hosts
    else
        echo -e "$ip az-rkirk-scaleset" | sudo tee -a /etc/hosts
    fi
    echo "Updated /etc/hosts with cloudscanner-dev -> $ip"
    
    # Update SSH config (follow symlink to actual file)
    local ssh_config_file
    ssh_config_file=$(readlink -f ~/.ssh/config 2>/dev/null || realpath ~/.ssh/config 2>/dev/null || echo ~/.ssh/config)
    
    if grep -q 'Host az-rkirk-scaleset' "$ssh_config_file"; then
        # Check if HostName line exists for this host
        if sed -n '/Host az-rkirk-scaleset/,/^Host /p' "$ssh_config_file" | grep -q 'HostName'; then
            # Update existing HostName
            sed "/Host az-rkirk-scaleset/,/^Host / s/HostName .*/HostName $ip/" "$ssh_config_file" > "${ssh_config_file}.tmp" && mv "${ssh_config_file}.tmp" "$ssh_config_file"
        else
            # Add HostName after Host line
            sed "/Host az-rkirk-scaleset/a\\
  HostName $ip
" "$ssh_config_file" > "${ssh_config_file}.tmp" && mv "${ssh_config_file}.tmp" "$ssh_config_file"
        fi
        echo "Updated ~/.ssh/config with az-rkirk-scaleset -> $ip"
    else
        echo "Warning: Host az-rkirk-scaleset not found in ~/.ssh/config"
    fi
}
